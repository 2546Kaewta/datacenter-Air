<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Data Center Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#06111a; --panel:#0f1724; --card:#0f1728;
  --muted:#9aa7b2; --accent:#2dd4bf; --accent-2:#38bdf8; --danger: #ff6b6b;
  --radius:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Inter',system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,#071422,#06111a);
  color:#e6f0f5; padding:20px; min-height: 100vh;
}
.container{
  max-width:1200px;margin:auto;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border-radius:var(--radius);padding:24px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow:0 10px 40px rgba(2,6,23,0.6);
}
header{display:flex;align-items:center;gap:14px;}
.logo{
  width:58px;height:58px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;align-items:center;justify-content:center;
  color:#021018;font-weight:800;font-size:18px;
}
h1{margin:0;font-size:20px}
.muted{color:var(--muted);font-size:13px}
.top-controls{margin-left:auto;display:flex;gap:12px;align-items:center}
.icon-btn{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--muted);
  width: 40px; height: 40px;
  border-radius:10px;cursor:pointer; font-size: 16px;
  transition: all 0.2s ease;
}
.icon-btn:hover{background:rgba(255,255,255,0.08);color:#fff}

.overview{
  display:grid; grid-template-columns: repeat(3, 1fr);
  gap:18px;margin-top:24px;
}
.card{
  background:var(--card);padding:24px;border-radius:var(--radius);
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow:0 6px 18px rgba(2,6,23,0.5);
  transition:transform 0.2s, box-shadow 0.2s;
  display: flex;
  align-items: center;
  gap: 16px;
}
.card:hover{transform:translateY(-4px); box-shadow:0 8px 25px rgba(2,6,23,0.7);}
.card .icon {
    font-size: 32px;
    color: var(--muted);
    background: rgba(255,255,255,0.03);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.small{font-size:13px;color:var(--muted)}
.big{font-size:32px;font-weight:800;margin-top:4px;}
#avgTemp { color: var(--accent-2); }
#avgHum { color: var(--accent); }
#acState { color: #fff; }


#chartContainer{
  margin-top:28px;background:var(--panel);
  padding:18px;border-radius:var(--radius);height:420px;
  border: 1px solid rgba(255,255,255,0.05);
}
footer{margin-top:18px;color:var(--muted);font-size:14px;text-align:right; display:flex; justify-content:flex-end; align-items:center; gap: 12px;}

.status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background-color: var(--muted);
    transition: background-color 0.5s ease;
}
.status-dot.online { background-color: var(--accent); }
.status-dot.error { background-color: var(--danger); }
.status-dot.connecting {
    background-color: var(--accent-2);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(0.9); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(0.9); opacity: 0.7; }
}

@media (max-width: 768px) {
    .overview { grid-template-columns: 1fr; }
    header { flex-direction: column; align-items: flex-start; }
    .top-controls { margin-left: 0; margin-top: 1rem; }
}
</style>
</head>

<body>
<div class="container">
  <header>
    <div class="logo">DC</div>
    <div>
      <h1>Data Center Air Control</h1>
      <div class="muted" id="outsideWeather">กำลังโหลดข้อมูลสภาพอากาศ...</div>
    </div>
    <div class="top-controls">
        <button id="refreshBtn" class="icon-btn" title="รีเฟรชข้อมูล"><i class="fa fa-sync"></i></button>
      <button id="adminBtn" class="icon-btn" title="แผงควบคุม"><i class="fa fa-cog"></i></button>
    </div>
  </header>

  <div class="overview">
    <div class="card">
        <div class="icon"><i class="fa fa-thermometer-half"></i></div>
        <div>
            <div class="small">อุณหภูมิปัจจุบัน</div>
            <div class="big" id="avgTemp">-- °C</div>
        </div>
    </div>
    <div class="card">
        <div class="icon"><i class="fa fa-tint"></i></div>
        <div>
            <div class="small">ความชื้นปัจจุบัน</div>
            <div class="big" id="avgHum">-- %</div>
        </div>
    </div>
    <div class="card">
        <div class="icon"><i class="fa fa-snowflake"></i></div>
        <div>
            <div class="small">สถานะแอร์</div>
            <div class="big" id="acState">--</div>
        </div>
    </div>
  </div>

  <div id="chartContainer">
    <canvas id="tempHumChart"></canvas>
  </div>

  <footer>
    <div class="status-dot connecting" id="statusDot"></div>
    <div id="statusText">กำลังเชื่อมต่อ...</div>
    <span>|</span>
    <span>อัปเดตล่าสุด: <span id="updated">--:--:--</span></span>
  </footer>
</div>

<script>
// ====== API Configuration ======
const API = {
    getLatest: 'api/get_latest_data.php',
    getHistorical: 'api/get_historical_data.php'
};
const REFRESH_INTERVAL_MS = 5000;

let chart, tempData=[], humData=[], labels=[], dataInterval;

// ====== Chart.js Initialization ======
function initChart(){
  const ctx = document.getElementById('tempHumChart').getContext('2d');
  chart = new Chart(ctx,{
    type:'line',
    data:{
      labels:labels,
      datasets:[
        {
          label:'อุณหภูมิ (°C)',
          data:tempData,
          borderColor: 'var(--accent-2)',
          backgroundColor:'rgba(56,189,248,0.15)',
          tension:0.35, fill: true,
          yAxisID:'yTemp'
        },
        {
          label:'ความชื้น (%)',
          data:humData,
          borderColor:'var(--accent)',
          backgroundColor:'rgba(45,212,191,0.15)',
          tension:0.35, fill: true,
          yAxisID:'yHum'
        }
      ]
    },
    // ===== MODIFIED SECTION =====
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      scales:{
        x:{
            title:{display:false},
            ticks: { color: '#e6f0f5', font: {size: 12} }, // <--- Changed color here
            grid: { color: 'rgba(255,255,255,0.05)' }
        },
        yTemp:{
            type:'linear',position:'left',
            title:{display:true,text:'อุณหภูมิ (°C)', color: 'var(--muted)'},
            ticks: { color: '#e6f0f5', font: {size: 12} }, // <--- Changed color here
            grid: { color: 'rgba(255,255,255,0.08)' }
        },
        yHum:{
            type:'linear',position:'right',
            title:{display:true,text:'ความชื้น (%)', color: 'var(--muted)'},
            ticks: { color: '#e6f0f5', font: {size: 12} }, // <--- Changed color here
            grid:{drawOnChartArea:false}
        }
      },
      plugins:{
        legend:{labels:{color:'#e6f0f5'}}, // <--- Changed color here
        tooltip: {
            backgroundColor: 'rgba(15, 23, 36, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
        }
      }
    }
    // ===== END OF MODIFIED SECTION =====
  });
}

// ====== UI and Connection Status Update ======
function updateStatusUI(status, message) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    statusDot.className = `status-dot ${status}`; // connecting, online, error
    statusText.textContent = message;
}

// ====== Fetch Historical Data for Chart ======
async function fetchHistoricalData() {
    try {
        const res = await fetch(API.getHistorical);
        const data = await res.json();
        
        labels.length = 0;
        tempData.length = 0;
        humData.length = 0;

        data.forEach(record => {
            labels.push(new Date(record.created_at).toLocaleTimeString('th-TH'));
            tempData.push(parseFloat(record.temperature));
            humData.push(parseFloat(record.humidity));
        });

        chart.update();
    } catch (err) {
        console.error('Error fetching historical data:', err);
        updateStatusUI('error', 'ไม่สามารถโหลดข้อมูลเริ่มต้นได้');
    }
}


// ====== Fetch Latest Data ======
async function fetchLatestData(){
  try{
    const res = await fetch(API.getLatest);
    const latest = await res.json();

    if(latest){
      const t = parseFloat(latest.temperature);
      const h = parseFloat(latest.humidity);

      document.getElementById('avgTemp').textContent = t.toFixed(1) + ' °C';
      document.getElementById('avgHum').textContent = h.toFixed(1) + ' %';
      document.getElementById('acState').textContent = latest.ac_status || 'ไม่ทราบ';
      document.getElementById('updated').textContent = new Date().toLocaleTimeString('th-TH');

      labels.push(new Date(latest.created_at).toLocaleTimeString('th-TH'));
      tempData.push(t);
      humData.push(h);

      if(labels.length > 60){
          labels.shift();
          tempData.shift();
          humData.shift();
      }
      chart.update('none');
      updateStatusUI('online', 'ออนไลน์');
    }
  }catch(err){
    console.error('Error fetching latest data:',err);
    updateStatusUI('error', 'การเชื่อมต่อล้มเหลว');
  }
}

// ====== Fetch External Weather (Optional) ======
async function fetchWeather(){
  const apiKey = "b4d3c7216713d8e9543b14c554fc8362";
  const url = `https://api.openweathermap.org/data/2.5/weather?q=Bangkok,TH&units=metric&lang=th&appid=${apiKey}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.main){
      document.getElementById('outsideWeather').textContent =
        `อากาศภายนอก: ${data.main.temp.toFixed(1)}°C, ${data.main.humidity}% (${data.weather[0].description})`;
    }
  }catch(e){
    document.getElementById('outsideWeather').textContent = "ไม่สามารถโหลดข้อมูลอากาศได้";
  }
}

// ====== Initialize Application ======
async function initialize() {
    initChart();
    await fetchHistoricalData();
    await fetchLatestData();
    fetchWeather();
    
    if(dataInterval) clearInterval(dataInterval);
    dataInterval = setInterval(fetchLatestData, REFRESH_INTERVAL_MS);
}

initialize();

// ====== Event Listeners ======
document.getElementById('adminBtn').addEventListener('click',()=>{
  window.location.href = 'admin.html';
});

document.getElementById('refreshBtn').addEventListener('click', () => {
    updateStatusUI('connecting', 'กำลังรีเฟรช...');
    fetchLatestData();
});

</script>
</body>
</html>